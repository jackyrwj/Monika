<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>This Waifu Does Not Exist</title>
    <style>
        @font-face {
            font-family: 'LXGWWenKaiGBScreen';
            src: url('LXGWWenKaiGBScreen.ttf') format('truetype');
            font-display: swap;
        }
        body {
            font-family: 'LXGWWenKaiGBScreen', sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }
        .container {
            width: auto;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        img {
            max-width: 100%;
            height: auto;
            border: 1px solid #ccc;
            box-sizing: border-box;
        }
        .flex-container {
            display: flex;
            gap: 20px;
            text-align: left;
            align-items: flex-start;
        }
        .image-container {
            width: 600px;
            height: 600px;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .image-container img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border: 1px solid #ccc;
            box-sizing: border-box;
        }
        .text-container {
            width: 500px;
            height: 600px;
            box-sizing: border-box;
            display: flex;
            align-items: flex-start;
            justify-content: flex-start;
            position: relative;
        }
        .text-box {
            width: 100%;
            height: 100%;
            overflow: auto;
            border: 1px solid #e0e0e0;
            border-radius: 18px;
            box-shadow: 0 4px 24px 0 rgba(0,0,0,0.08), 0 1.5px 4px 0 rgba(0,0,0,0.04);
            padding: 28px 32px 24px 32px;
            background: #fafbfc;
            box-sizing: border-box;
            font-family: 'LXGWWenKaiGBScreen', sans-serif;
            font-size: 1.15em;
            color: #222;
            transition: box-shadow 0.2s;
        }
        .text-box:hover {
            box-shadow: 0 8px 32px 0 rgba(0,0,0,0.13), 0 2px 8px 0 rgba(0,0,0,0.07);
        }
        .text-box h2,
        .typing-title {
            text-align: center;
            font-size: 2em;
            margin-top: 0;
            margin-bottom: 0.5em;
            font-weight: bold;
            letter-spacing: 1px;
            color: #3a3a3a;
        }
        .text-box div {
            margin-bottom: 0.5em;
        }
        button {
            margin-top: 20px;
            padding: 10px 15px;
            cursor: pointer;
        }
        .social-icons {
            position: absolute;
            top: 20px;
            right: 40px;
            z-index: 1000;
            display: flex;
            gap: 16px;
        }
        .social-icons a {
            display: inline-block;
            transition: transform 0.2s;
        }
        .social-icons a:hover {
            transform: scale(1.15);
        }
        .music-control {
            position: absolute;
            top: 60px;
            right: 40px;
            z-index: 1001;
            display: flex;
            align-items: center;
        }
        #mute-btn {
            background: #fff;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            font-size: 20px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }
        #mute-btn:hover {
            background: #eee;
        }
        .social-icons img {
            border: none !important;
            background: none;
            box-shadow: none;
        }
        #refresh-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: auto;
            margin-right: auto;
            width: 180px;
            height: 48px;
            border: 1.5px solid #222;
            border-radius: 28px;
            background: #fff;
            color: #222;
            font-size: 1.18em;
            font-weight: bold;
            box-shadow: none;
            transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
            gap: 10px;
            letter-spacing: 1px;
            outline: none;
            cursor: pointer;
            margin-top: 32px;
        }
        #refresh-btn:hover {
            background: #f5f5f5;
            color: #2193b0;
            border-color: #2193b0;
            box-shadow: none;
            transform: none;
        }
        #refresh-btn svg {
            flex-shrink: 0;
        }
        .button-row {
            display: flex;
            justify-content: center;
            gap: 0;
            margin-top: 32px;
        }
        .btn-modern {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 120px;
            height: 44px;
            border: 1.5px solid #222;
            border-radius: 24px;
            background: #fff;
            color: #222;
            font-size: 1.08em;
            font-weight: bold;
            gap: 8px;
            letter-spacing: 1px;
            outline: none;
            cursor: pointer;
            transition: background 0.18s, color 0.18s, border 0.18s, box-shadow 0.18s;
            box-shadow: none;
            user-select: none;
        }
        .btn-modern:hover {
            background: #f5f5f5;
            color: #2193b0;
            border-color: #2193b0;
        }
        .btn-modern svg {
            flex-shrink: 0;
        }
        .textbox-speed-controls {
            position: absolute;
            top: 16px;
            right: 24px;
            display: flex;
            gap: 10px;
            z-index: 2;
        }
        .language-controls {
            position: absolute;
            top: 20px;
            right: 120px;
            z-index: 1002;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .language-select {
            padding: 6px 12px;
            border: 1.5px solid #222;
            border-radius: 20px;
            background: #fff;
            color: #222;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            outline: none;
            transition: all 0.2s;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 16px;
            padding-right: 32px;
        }
        .language-select:hover {
            background-color: #f5f5f5;
            border-color: #2193b0;
            color: #2193b0;
        }
        .language-select:focus {
            border-color: #2193b0;
            box-shadow: 0 0 0 2px rgba(33,147,176,0.2);
        }
        .speed-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 50%;
            background: #f5f5f5;
            color: #2193b0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.18s, box-shadow 0.18s;
            box-shadow: 0 1px 4px 0 rgba(33,147,176,0.08);
            font-size: 1.1em;
            outline: none;
            padding: 0;
        }
        .speed-btn:hover {
            background: #e0f7fa;
        }
    </style>
</head>
<body>
    <div class="social-icons">
        <a href="https://x.com/lilmonix3" target="_blank" title="Twitter">
            <svg width="28" height="28" viewBox="0 0 32 32" fill="#1da1f2"><path d="M32 6.076a13.14 13.14 0 0 1-3.769 1.031A6.601 6.601 0 0 0 31.115 4.1a13.195 13.195 0 0 1-4.169 1.594A6.563 6.563 0 0 0 22.155 2c-3.626 0-6.563 2.938-6.563 6.563 0 .514.058 1.016.17 1.496C10.272 9.87 5.444 7.575 2.228 4.149a6.548 6.548 0 0 0-.888 3.3c0 2.277 1.159 4.287 2.924 5.463a6.533 6.533 0 0 1-2.975-.822v.083c0 3.181 2.263 5.834 5.267 6.437a6.575 6.575 0 0 1-2.968.112c.837 2.613 3.263 4.514 6.142 4.566A13.18 13.18 0 0 1 0 27.026 18.616 18.616 0 0 0 10.063 30c12.072 0 18.681-10.002 18.681-18.682 0-.285-.007-.568-.02-.85A13.348 13.348 0 0 0 32 6.076z"/></svg>
        </a>
        <a href="https://discord.com/channels/372766620977725441/472534487574642718" target="_blank" title="Discord">
            <img src="discord.svg" width="28" height="28" alt="Discord" />
        </a>
        <a href="https://store.steampowered.com/app/698780/Doki_Doki_Literature_Club/" target="_blank" title="Steam">
            <img src="steam.svg" width="28" height="28" alt="Steam" />
        </a>
    </div>
    <div class="language-controls">
        <select id="lang-select" class="language-select">
            <option value="zh">中文</option>
            <option value="en">English</option>
        </select>
    </div>
    <div class="container">
        <h1>"Monika Is Not Real"</h1>
        <p>(Model & site by Gwern Branwen.)</p>
        <p>NEWEST &rarr; This Anime Does Not Exist</p>

        <div class="flex-container">
            <div class="image-container">
                <img src="images/10.webp" alt="Anime character">
            </div>
            <div class="text-container">
                <div class="textbox-speed-controls">
                    <button id="speed-down-btn" class="speed-btn" title="减速">⏪</button>
                    <button id="speed-up-btn" class="speed-btn" title="加速">⏩</button>
                    <span id="speed-indicator" style="font-size:12px;color:#888;margin-left:8px;align-self:center;"></span>
                </div>
                <div class="text-box"></div>
            </div>
        </div>

        <div class="music-control">
            <audio id="bgm" src="bgm.mp3" loop autoplay></audio>
            <button id="mute-btn" title="静音/播放" style="margin-left: 10px;">
                🔊
            </button>
        </div>

        <div class="button-row">
            <button id="refresh-btn" class="btn-modern">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M17.65 6.35A7.95 7.95 0 0 0 10 2V0L6 4l4 4V6c3.31 0 6 2.69 6 6a6 6 0 0 1-6 6 6 6 0 0 1-5.65-4H2.26A8 8 0 1 0 18 10c0-1.08-.19-2.12-.54-3.08l.19-.57z" fill="#222"/></svg>
                刷新
            </button>
        </div>
    </div>

    <script>
        let imageList = [
            '10.webp', '11.webp', '12.jpeg', '13.jpeg', '14.jpeg', '15.jpeg',
            '16.jpeg', '17.jpeg', '18.jpeg', '19.webp', '20.webp', '21.webp'
        ];
        let fragments = [];
        let currentIndex = 0;
        let currentImageIndex = 0;
        let typingTimer = null;
        let switchTimer = null;
        let currentLang = 'zh';
        const textBox = document.querySelector('.text-box');
        const refreshBtn = document.getElementById('refresh-btn');
        const minSpeed = 10;
        const maxSpeed = 500;
        const speedStep = 100;
        let typingSpeed = 210;
        const speedUpBtn = document.getElementById('speed-up-btn');
        const speedDownBtn = document.getElementById('speed-down-btn');
        const langSelect = document.getElementById('lang-select');

        console.log('图片列表加载完成，共', imageList.length, '张图片');
        console.log('图片列表内容:', imageList);

        // 加载文本片段
        fetch('fragments.json')
            .then(res => {
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                return res.json();
            })
            .then(data => {
                if (!Array.isArray(data) || data.length === 0) {
                    throw new Error('文本片段为空或格式不正确');
                }
                fragments = data;
                console.log('文本片段加载完成，共', fragments.length, '段');
                console.log('第一段内容:', fragments[0]);
                showFragment(currentIndex);
            })
            .catch(error => {
                console.error('加载文本片段失败:', error);
            });

        function renderFragmentText(fragment) {
            const lang = currentLang;
            let text = '';
            if (lang === 'zh') {
                text = fragment.title + '\n';
                text += fragment.content.join('\n');
            } else {
                text = fragment.title_en + '\n';
                text += fragment.content_en.join('\n');
            }
            return text;
        }

        function typeWriterText(fragment, element, callback) {
            const lang = currentLang;
            console.log('当前语言:', lang);
            console.log('当前片段:', fragment);
            
            // 检查片段是否包含必要的字段
            if (!fragment) {
                console.error('片段为空');
                return;
            }
            
            // 根据语言选择标题和内容
            let title, lines;
            if (lang === 'zh') {
                title = fragment.title;
                lines = fragment.content;
            } else {
                title = fragment.title_en;
                lines = fragment.content_en;
            }
            
            // 检查标题和内容是否存在
            if (!title || !lines) {
                console.error('缺少必要的字段:', {
                    title: title,
                    lines: lines,
                    fragment: fragment,
                    lang: lang
                });
                // 如果缺少英文翻译，回退到中文
                if (lang === 'en') {
                    console.log('回退到中文显示');
                    title = fragment.title;
                    lines = fragment.content;
                } else {
                    return;
                }
            }
            
            console.log('标题:', title);
            console.log('内容:', lines);
            
            let lineIndex = 0;
            let charIndex = 0;
            element.innerHTML = `<h2 class="typing-title">${title}</h2><div class="typing-content"></div>`;
            const contentElem = element.querySelector('.typing-content');
            let finishedLines = [];
            
            function typeLine() {
                if (lineIndex < lines.length) {
                    const currentLine = (lang === 'zh' ? '莫妮卡：' : 'Monika: ') + lines[lineIndex];
                    let currentText = '';
                    function typeChar() {
                        if (charIndex < currentLine.length) {
                            currentText += currentLine.charAt(charIndex);
                            contentElem.innerHTML = finishedLines.map(l => `<div>${l}</div>`).join('') + `<div>${currentText}</div>`;
                            charIndex++;
                            typingTimer = setTimeout(typeChar, typingSpeed);
                        } else {
                            finishedLines.push(currentLine);
                            charIndex = 0;
                            lineIndex++;
                            typingTimer = setTimeout(typeLine, typingSpeed);
                        }
                    }
                    typeChar();
                } else {
                    let html = `<h2 style='margin-top:0;' class='typing-title'>${title}</h2>`;
                    html += lines.map(line => `<div>${lang === 'zh' ? '莫妮卡：' : 'Monika: '}${line}</div>`).join('');
                    element.innerHTML = html;
                    if (callback) callback();
                }
            }
            typeLine();
        }

        function showFragment(index) {
            clearTimeout(typingTimer);
            clearTimeout(switchTimer);

            // 1. 立即切换图片
            const imageElement = document.querySelector('.image-container img');
            if (imageElement && imageList.length > 0) {
                console.log('切换图片 - 当前索引:', currentImageIndex);
                console.log('切换图片 - 图片列表长度:', imageList.length);
                console.log('切换图片 - 目标图片:', imageList[currentImageIndex]);
                
                // 确保图片路径正确
                const imagePath = 'images/' + imageList[currentImageIndex];
                imageElement.src = imagePath;
                console.log('设置图片路径:', imagePath);
                
                currentImageIndex = (currentImageIndex + 1) % imageList.length;
            } else {
                console.warn('无法切换图片:', {
                    hasImageElement: !!imageElement,
                    imageListLength: imageList.length,
                    currentImageIndex: currentImageIndex
                });
            }

            // 2. 然后再切换文字（打字动画）
            const fragment = fragments[index];
            if (fragment) {
                typeWriterText(fragment, textBox, () => {
                    switchTimer = setTimeout(() => {
                        nextFragment();
                    }, 50000);
                });
            } else {
                console.error('文本片段不存在:', index);
            }
        }

        function nextFragment() {
            console.log('切换到下一段 - 当前索引:', currentIndex);
            currentIndex = (currentIndex + 1) % fragments.length;
            showFragment(currentIndex);
        }

        refreshBtn.addEventListener('click', () => {
            console.log('点击刷新按钮');
            nextFragment();
        });

        // 语言切换
        langSelect.addEventListener('change', () => {
            currentLang = langSelect.value;
            console.log('切换语言:', currentLang);
            // 只更新文本内容，不改变其他元素
            const fragment = fragments[currentIndex];
            if (fragment) {
                console.log('当前片段:', fragment);
                clearTimeout(typingTimer);
                clearTimeout(switchTimer);
                typeWriterText(fragment, textBox, () => {
                    if (switchTimer) {
                        clearTimeout(switchTimer);
                        switchTimer = setTimeout(() => {
                            nextFragment();
                        }, 50000);
                    }
                });
            } else {
                console.error('片段不存在:', currentIndex);
            }
        });

        // 设置初始语言
        langSelect.value = currentLang;

        // 音乐播放与静音控制
        const audio = document.getElementById('bgm');
        const muteBtn = document.getElementById('mute-btn');
        let isMuted = true;

        muteBtn.textContent = '🔇';
        audio.muted = true;

        function tryPlay() {
            audio.muted = isMuted;
            audio.volume = 1;
            audio.play().catch(() => {});
        }

        document.addEventListener('DOMContentLoaded', function() {
            tryPlay();
        });

        window.addEventListener('load', tryPlay);

        muteBtn.onclick = function() {
            isMuted = !isMuted;
            audio.muted = isMuted;
            muteBtn.textContent = isMuted ? '🔇' : '🔊';
            tryPlay();
        };

        window.addEventListener('click', function once() {
            tryPlay();
            window.removeEventListener('click', once);
        });

        // 速度控制
        function updateSpeedIndicator() {
            document.getElementById('speed-indicator').textContent = typingSpeed + 'ms';
        }
        speedUpBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            typingSpeed = Math.max(minSpeed, typingSpeed - speedStep);
            updateSpeedIndicator();
        });
        speedDownBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            typingSpeed = Math.min(maxSpeed, typingSpeed + speedStep);
            updateSpeedIndicator();
        });
        updateSpeedIndicator();
    </script>
</body>
</html> 